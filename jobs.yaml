- job-template:
    name: "{name}-upstream"
    project-type: freestyle
    node: cloud
    logrotate:
      daysToKeep: 10
      numToKeep: 20
      artifactDaysToKeep: 7
      artifactNumToKeep: 15
    scm:
      - git:
          url: https://github.com/{organization}/{name}.git
          branches:
            - master

    triggers:
      - pollscm: "H/15 * * * *"

    builders:
      - shell: "tox -e py27"

    properties:
      - github:
          url: https://github.com/{organization}/{name}/

    publishers:
      - ircbot:
          strategy: failure-and-fixed
          matrix-notifier: only-configurations


- job-group:
    name: upstream-project
    jobs:
      - "{name}-upstream"

- project:
    name: nova
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: python-novaclient
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: glance
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: python-glanceclient
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: horizon
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: swift
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: python-swiftclient
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: keystone
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: python-keystoneclient
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: neutron
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: python-neutronclient
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: cinder
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: python-cinderclient
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: oslo-incubator
    organization: openstack
    jobs:
      - upstream-project

- project:
    name: basicdb
    organization: sorenh
    jobs:
      - upstream-project


- job:
    name: cinder-jiocloud
    project-style: freestyle
    node: cloud
    scm:
      - git:
          url: git@github.com:openstack/cinder.git
          name: origin
          branches:
            - origin/master
      - git:
          url: git@github.com:JioCloud/cinder.git
          name: jiocloud
          merge:
            branch: jiocloud/devmaster
      - git:
          url: git@github.com:JioCloud/cinder.git
          name: jiocloud
          merge:
            branch: jiocloud/manualmaster

    triggers:
      - pollscm: "H/15 * * * *"

    builders:
      - shell: |
          #!/bin/bash
          if [ "$GIT_BRANCH" = "origin/master" ]
          then
            # Push rebased changes to jiocloud/master, and merged 
            # changes to jiocloud/devmaster
          
            git checkout -b jiocloud_master jiocloud/master;
            git rebase origin/master;
            tox -e py27;
            git push jiocloud jiocloud_master:master --force;
          
            # If rebase succeeds, then merge too will!
            # NOTE!: merge may not, as jiocloud/devmaster might have 
            # changed, but that is user's fault!
            git checkout -b jiocloud_devmaster jiocloud/devmaster;
            git branch -D jiocloud_master;
            git merge origin/master;
            git push jiocloud jiocloud_devmaster:devmaster;
          
            git checkout master;
            git branch -D jiocloud_devmaster;
            git remote update jiocloud;
          elif [ "$GIT_BRANCH" = "jiocloud/manualmaster" ]
          then
            git checkout -b jiocloud_manualmaster;
            tox -e py27;
            git push jiocloud jiocloud_manualmaster:master --force;
            git checkout master;
            git branch -D jiocloud_manualmaster;
          elif [ "$GIT_BRANCH" = "jiocloud/devmaster" ]
          then
            git checkout -b jiocloud_devmaster jiocloud/devmaster;
            git rebase jiocloud/master;
            tox -e py27;
            git push jiocloud jiocloud_devmaster:master --force;
            git checkout master;
            git branch -D jiocloud_devmaster;
          elif [ "$GIT_BRANCH" = "jiocloud/master" ]
          then
            echo "Not building jiocloud/master branch. Skipping";
          else
            exit 1;
          fi

    properties:
      - github:
          url: https://github.com/JioCloud/cinder/

    publishers:
      - git:
          push-merge: false
          push-only-if-success: true
          branches:
            - branch:
                remote: jiocloud
                name: dev/master
      - ircbot:
          strategy: failure-and-fixed
          matrix-notifier: only-configurations

